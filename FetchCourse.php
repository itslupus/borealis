<?php
    //{"result":{"sections":{"A02":{"crn":"10112","cap":"160","cnt":"128","rem":"32","wl_cap":"999","wl_cnt":"0","wl_rem":"999","instr":"Heather Matheson (P)","meets":[{"days":"MWF","time":"09:30 am-10:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a laboratory\/tutorial. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below."},"A04":{"crn":"10115","cap":"160","cnt":"71","rem":"89","wl_cap":"999","wl_cnt":"0","wl_rem":"999","instr":"TBA","meets":[{"days":"MWF","time":"12:30 pm-01:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a laboratory\/tutorial. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below."},"A03":{"crn":"10114","cap":"160","cnt":"153","rem":"7","wl_cap":"1998","wl_cnt":"2","wl_rem":"1996","instr":"Celine Latulipe (P)","meets":[{"days":"TR","time":"10:00 am-11:15 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a laboratory\/tutorial. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. Some space is reserved for Faculty of Management students until August 12, 2020 at 9:00 AM."},"B04":{"crn":"10120","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"10:30 am-11:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B11":{"crn":"10129","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"10:30 am-11:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B02":{"crn":"10117","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"11:30 am-12:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B14":{"crn":"12792","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"12:30 pm-01:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B06":{"crn":"10122","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"01:30 pm-02:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B12":{"crn":"10134","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"01:30 pm-02:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B08":{"crn":"10125","cap":"30","cnt":"30","rem":"0","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"02:30 pm-03:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B13":{"crn":"10135","cap":"30","cnt":"24","rem":"6","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"02:30 pm-03:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B10":{"crn":"10127","cap":"30","cnt":"15","rem":"15","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"03:30 pm-04:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B15":{"crn":"12793","cap":"30","cnt":"9","rem":"21","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"W","time":"03:30 pm-04:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B01":{"crn":"10116","cap":"30","cnt":"5","rem":"25","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"09:30 am-10:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B03":{"crn":"10119","cap":"30","cnt":"24","rem":"6","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"10:30 am-11:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B17":{"crn":"14100","cap":"30","cnt":"9","rem":"21","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"10:30 am-11:20 am","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B05":{"crn":"10121","cap":"30","cnt":"18","rem":"12","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"11:30 am-12:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B07":{"crn":"10123","cap":"30","cnt":"11","rem":"19","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"01:30 pm-02:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B09":{"crn":"10126","cap":"30","cnt":"22","rem":"8","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"02:30 pm-03:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active below. This section will be assessed a lab fee."},"B16":{"crn":"14099","cap":"30","cnt":"5","rem":"25","wl_cap":"0","wl_cnt":"0","wl_rem":"0","instr":"Heather Matheson (P)","meets":[{"days":"F","time":"02:30 pm-03:20 pm","bounds":"09\/09-12\/11","location":"TBA"}],"desc":"This section must be taken with a lecture. This is a Remote Learning course.  Check for critical information regarding course delivery by clicking on the Syllabus Available link if active belo* Closing connection 0w. This section will be assessed a lab fee."},"D01":{"crn":"10784","cap":"500","cnt":"5","rem":"495","wl_cap":"999","wl_cnt":"0","wl_rem":"999","instr":"TBA","meets":[{"days":"\u00a0","time":"TBA","bounds":"09\/09-12\/11","location":"Distance And On-Line Education"}],"desc":"This is a Distance and Online Education course. Your course content will be accessible on  UMLearn.  Must have access to a computer with internet access to submit assignments and write tests."}}}}
    require_once(__DIR__ . '/include/MrManager.php');

    require_once(__DIR__ . '/object/CURL.php');
    require_once(__DIR__ . '/object/Token.php');
    require_once(__DIR__ . '/object/Page.php');

    if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
        // 405 method not allowed
        http_response_code(405);
        die();
    }

    if (!isset($_COOKIE['token']) || !isset($_POST['term']) || !isset($_POST['course_code'])) {
        // 400 bad request
        http_response_code(400);
        die();
    }

    $course_code = explode(' ', $_POST['course_code']);

    if (count($course_code) !== 2) {
        // 400 bad request
        http_response_code(400);
        die();
    }

    $manager = new MrManager();
    $config = $manager->get_config();
    $token = null;

    try {
        $token = $manager->validate_token($_COOKIE['token']);
        $token = $manager->regenerate_token($token);

        $manager->validate_banner_session($token);
        $manager->set_token_cookie($token);
    } catch (MrManagerInvalidToken $e) {
        // 401 unauth
        http_response_code(401);
        die('invalid token');
    } catch (MrManagerInvalidBannerSession $e2) {
        // 401 unauth
        http_response_code(401);
        die('invalid banner');
    } catch (MrManagerExpiredToken $e3) {
        // 401 unauth
        http_response_code(401);
        die('expired token');
    }
    
    $curl = $manager->get_curl_object($token->get_tmp_file_name());

    $data = array(
        'term_in' => $_POST['term'],
        'sel_subj' => ['dummy', $course_code[0]],
        'SEL_CRSE' => $course_code[1],
        'SEL_TITLE' => '',
        'BEGIN_HH' => '0',
        'BEGIN_MI' => '0',
        'BEGIN_AP' => 'a',
        'SEL_DAY' => 'dummy',
        'SEL_PTRM' => 'dummy',
        'END_HH' => '0',
        'END_MI' => '0',
        'END_AP' => 'a',
        'SEL_CAMP' => 'dummy',
        'SEL_SCHD' => 'dummy',
        'SEL_SESS' => 'dummy',
        'SEL_INSTR' => ['dummy', '%'],
        'SEL_ATTR' => ['dummy', '%'],
        'SEL_LEVL' => ['dummy', '%'],
        'SEL_INSM' => 'dummy',
        'sel_dunt_code' => '',
        'sel_dunt_unit' => '',
        'call_value_in' => '',
        'rsts' => 'dummy',
        'crn' => 'dummy',
        'path' => '1',
        'SUB_BTN' => 'View Sections'
    );
    $data = http_build_query($data);
    $data = preg_replace('/\%5B[0-9]\%5D/', '', $data);

    $curl->set_post($data);
    $result = $curl->get_page('/banprod/bwskfcls.P_GetCrse');

    $page = new Page($result);

    $rows = $page->query('//table[@class = "datadisplaytable"]/tr');

    $sections = array();

    $new_section = array();
    $curr_section = '';
    for ($i = 2; $i < $rows->length; $i++) {
        $row = $rows->item($i);
        $cells = $page->query('.//td', $row);

        if ($cells->length === 1) {
            $sections[$curr_section] = $new_section;

            $new_section = array();
            $curr_section = '';
        } else if ($cells->length === 2) {
            $new_section['desc'] = trim($cells->item(1)->textContent);
        } else if ($cells->length > 2) {
            if ($curr_section !== '') {
                array_push($new_section['meets'], array(
                    'days' => trim($cells->item(8)->textContent),
                    'time' => trim($cells->item(9)->textContent),
                    'bounds' => trim($cells->item(17)->textContent),
                    'location' => trim($cells->item(18)->textContent)
                ));
            } else {
                $curr_section = trim($cells->item(4)->textContent);

                $new_section['crn'] = trim($cells->item(1)->textContent);
    
                $new_section['cap'] = trim($cells->item(10)->textContent);
                $new_section['cnt'] = trim($cells->item(11)->textContent);
                $new_section['rem'] = trim($cells->item(12)->textContent);
    
                $new_section['wl_cap'] = trim($cells->item(13)->textContent);
                $new_section['wl_cnt'] = trim($cells->item(14)->textContent);
                $new_section['wl_rem'] = trim($cells->item(15)->textContent);
    
                $new_section['instr'] = trim($cells->item(16)->textContent);
    
                $new_section['meets'] = array(
                    array(
                        'days' => trim($cells->item(8)->textContent),
                        'time' => trim($cells->item(9)->textContent),
                        'bounds' => trim($cells->item(17)->textContent),
                        'location' => trim($cells->item(18)->textContent)
                    )
                );
            }
        }
    }

    $result = array(
        'result' => array('sections' => $sections)
    );

    header('Content-Type: text/json');
    http_response_code(200);
    echo(json_encode($result));
?>